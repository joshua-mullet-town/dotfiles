#!/bin/bash

# Claude Code Hooks Management CLI v2
# Enhanced interactive menu with arrow key navigation and hotkeys

HOOKS_CONFIG="$HOME/.claude/hooks-config.json"
CLAUDE_SETTINGS="$HOME/.claude/settings.json"

# Enhanced colors for better UX
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
GRAY='\033[0;37m'
BOLD='\033[1m'
DIM='\033[2m'
HIGHLIGHT='\033[7m'  # Reverse video for selection
NC='\033[0m' # No Color

# Menu state
SELECTED_ITEM=1

# Utility functions
hide_cursor() { printf '\033[?25l'; }
show_cursor() { printf '\033[?25h'; }
move_up() { printf '\033[1A'; }
clear_line() { printf '\033[2K\r'; }

# Cleanup on exit
cleanup() {
    show_cursor
    exit 0
}
trap cleanup EXIT INT

# Read single key without Enter
read_key() {
    local key
    IFS= read -rsn1 key 2>/dev/null
    
    # Handle special keys (arrow keys, escape sequences)
    if [[ $key == $'\033' ]]; then
        # Read the next two characters for escape sequences
        read -rsn2 key 2>/dev/null
        case $key in
            '[A') echo "UP" ;;
            '[B') echo "DOWN" ;;
            '[C') echo "RIGHT" ;;
            '[D') echo "LEFT" ;;
            *) echo "ESC" ;;
        esac
    else
        case $key in
            '') echo "ENTER" ;;
            'q'|'Q') echo "QUIT" ;;
            *) echo "$key" ;;
        esac
    fi
}

# Enhanced menu display with selection highlighting
draw_menu() {
    local title="$1"
    local -a options=("${@:2}")
    local max_items=${#options[@]}
    
    clear
    
    # Header
    echo -e "${CYAN}╔══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}${BOLD}                $title                ${NC}${CYAN}║${NC}"
    echo -e "${CYAN}╚══════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    # Menu items
    for i in "${!options[@]}"; do
        local item_num=$((i + 1))
        local option="${options[i]}"
        
        if [[ $item_num -eq $SELECTED_ITEM ]]; then
            # Highlighted selection
            echo -e "${HIGHLIGHT}${WHITE} ► $item_num. $option ${NC}"
        else
            # Normal items
            echo -e "   ${BLUE}$item_num.${NC} $option"
        fi
    done
    
    echo ""
    
    # Help text
    echo -e "${DIM}${GRAY}Navigation: ${WHITE}↑↓${GRAY} arrows, ${WHITE}Enter${GRAY} select, ${WHITE}1-9${GRAY} hotkey, ${WHITE}ESC/Q${GRAY} quit${NC}"
}

# Handle menu navigation
navigate_menu() {
    local title="$1"
    local -a options=("${@:2}")
    local max_items=${#options[@]}
    
    SELECTED_ITEM=1
    hide_cursor
    
    while true; do
        draw_menu "$title" "${options[@]}"
        
        local key
        key=$(read_key)
        
        case $key in
            "UP")
                ((SELECTED_ITEM--))
                [[ $SELECTED_ITEM -lt 1 ]] && SELECTED_ITEM=$max_items
                ;;
            "DOWN")
                ((SELECTED_ITEM++))
                [[ $SELECTED_ITEM -gt $max_items ]] && SELECTED_ITEM=1
                ;;
            "ENTER")
                show_cursor
                return $SELECTED_ITEM
                ;;
            "ESC"|"QUIT")
                show_cursor
                return 0
                ;;
            [1-9])
                if [[ $key -le $max_items ]]; then
                    SELECTED_ITEM=$key
                    show_cursor
                    return $key
                fi
                ;;
        esac
    done
}

# Ensure hooks config exists
ensure_hooks_config() {
    if [[ ! -f "$HOOKS_CONFIG" ]]; then
        echo '{
  "notifications": {
    "enabled": true,
    "type": "beep"
  },
  "aws_profiles": {}
}' > "$HOOKS_CONFIG"
    fi
}

# Backup settings before modification
backup_settings() {
    if [[ -f "$CLAUDE_SETTINGS" ]]; then
        cp "$CLAUDE_SETTINGS" "$CLAUDE_SETTINGS.backup.$(date +%Y%m%d_%H%M%S)"
    fi
}

# Get current git repo name
get_current_repo() {
    if git rev-parse --git-dir >/dev/null 2>&1; then
        REPO_URL=$(git remote get-url origin 2>/dev/null || echo "")
        if [[ -n "$REPO_URL" ]]; then
            basename "$REPO_URL" .git
        fi
    fi
}

# Enhanced notification settings menu
notification_menu() {
    while true; do
        # Get current settings
        local CURRENT_STATUS=$(python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
    print('Enabled' if config.get('notifications', {}).get('enabled', True) else 'Disabled')
except:
    print('Enabled')
")
        
        local CURRENT_TYPE=$(python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
    print(config.get('notifications', {}).get('type', 'beep'))
except:
    print('beep')
")

        local status_text="Status: ${GREEN}$CURRENT_STATUS${NC} | Sound: ${GREEN}$CURRENT_TYPE${NC}"
        
        local options=(
            "Toggle Notifications (Currently: $CURRENT_STATUS)"
            "Change Sound Type (Currently: $CURRENT_TYPE)"
            "Test Current Sound"
            "Back to Main Menu"
        )
        
        echo -e "\n$status_text\n"
        
        navigate_menu "Notification Settings" "${options[@]}"
        local choice=$?
        
        case $choice in
            0) return ;;  # ESC/Quit
            1) # Toggle notifications
                local new_state="false"
                [[ "$CURRENT_STATUS" == "Disabled" ]] && new_state="true"
                
                python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
except:
    config = {}
config.setdefault('notifications', {})['enabled'] = $new_state
with open('$HOOKS_CONFIG', 'w') as f:
    json.dump(config, f, indent=2)
"
                clear
                echo -e "${GREEN}✓ Notifications $([ "$new_state" = "true" ] && echo "enabled" || echo "disabled")${NC}"
                sleep 2
                ;;
            2) # Change sound type
                sound_selection_menu
                ;;
            3) # Test current sound
                clear
                echo -e "${BLUE}Testing current sound...${NC}"
                /Users/joshuamullet/.claude/hooks/notification-beep.sh
                echo -e "\nPress any key to continue..."
                read -n 1 -s
                ;;
            4) # Back
                return
                ;;
        esac
    done
}

# Sound selection submenu
sound_selection_menu() {
    local options=(
        "System Beep (subtle)"
        "System Sound (Glass.aiff - noticeable)"  
        "Multiple Beeps (loud - 3 beeps)"
        "Test All Sounds"
        "Back to Notification Settings"
    )
    
    while true; do
        navigate_menu "Select Notification Sound" "${options[@]}"
        local choice=$?
        
        case $choice in
            0|5) return ;;  # ESC/Quit or Back
            1) # System beep
                python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
except:
    config = {}
config.setdefault('notifications', {})['type'] = 'beep'
with open('$HOOKS_CONFIG', 'w') as f:
    json.dump(config, f, indent=2)
"
                clear
                echo -e "${GREEN}✓ Sound set to: System Beep${NC}"
                /Users/joshuamullet/.claude/hooks/notification-beep.sh
                sleep 2
                return
                ;;
            2) # System sound
                python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
except:
    config = {}
config.setdefault('notifications', {})['type'] = 'sound'
with open('$HOOKS_CONFIG', 'w') as f:
    json.dump(config, f, indent=2)
"
                clear
                echo -e "${GREEN}✓ Sound set to: System Sound${NC}"
                /Users/joshuamullet/.claude/hooks/notification-beep.sh
                sleep 2
                return
                ;;
            3) # Multiple beeps
                python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
except:
    config = {}
config.setdefault('notifications', {})['type'] = 'loud'
with open('$HOOKS_CONFIG', 'w') as f:
    json.dump(config, f, indent=2)
"
                clear
                echo -e "${GREEN}✓ Sound set to: Multiple Beeps${NC}"
                /Users/joshuamullet/.claude/hooks/notification-beep.sh
                sleep 2
                return
                ;;
            4) # Test all sounds
                clear
                echo -e "${BLUE}Testing all sound types...${NC}\n"
                
                echo -e "1. System Beep:"
                python3 -c "
import json
config = {'notifications': {'enabled': True, 'type': 'beep'}}
with open('$HOOKS_CONFIG', 'w') as f:
    json.dump(config, f, indent=2)
"
                /Users/joshuamullet/.claude/hooks/notification-beep.sh
                sleep 2
                
                echo -e "\n2. System Sound:"
                python3 -c "
import json
config = {'notifications': {'enabled': True, 'type': 'sound'}}
with open('$HOOKS_CONFIG', 'w') as f:
    json.dump(config, f, indent=2)
"
                /Users/joshuamullet/.claude/hooks/notification-beep.sh
                sleep 2
                
                echo -e "\n3. Multiple Beeps:"
                python3 -c "
import json
config = {'notifications': {'enabled': True, 'type': 'loud'}}
with open('$HOOKS_CONFIG', 'w') as f:
    json.dump(config, f, indent=2)
"
                /Users/joshuamullet/.claude/hooks/notification-beep.sh
                
                echo -e "\nPress any key to continue..."
                read -n 1 -s
                ;;
        esac
    done
}

# AWS profile management menu
aws_profile_menu() {
    while true; do
        clear
        echo -e "${PURPLE}Current AWS Profile Mappings:${NC}"
        python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
    profiles = config.get('aws_profiles', {})
    if profiles:
        for repo, profile in profiles.items():
            print(f'  {repo} → {profile}')
    else:
        print('  (No mappings configured)')
except:
    print('  (No mappings configured)')
"
        echo ""
        
        CURRENT_REPO=$(get_current_repo)
        if [[ -n "$CURRENT_REPO" ]]; then
            echo -e "${BLUE}Current repository:${NC} $CURRENT_REPO"
            echo ""
        fi
        
        local options=(
            "Add/Update AWS Profile for Current Repository"
            "Add/Update AWS Profile for Any Repository"
            "Remove AWS Profile Mapping"
            "List Available AWS Profiles"
            "Back to Main Menu"
        )
        
        navigate_menu "AWS Profile Mappings" "${options[@]}"
        local choice=$?
        
        case $choice in
            0|5) return ;;  # ESC/Quit or Back
            1) # Current repo
                if [[ -n "$CURRENT_REPO" ]]; then
                    show_cursor
                    clear
                    echo -e "${BLUE}Setting AWS profile for repository: ${WHITE}$CURRENT_REPO${NC}\n"
                    read -p "Enter AWS profile name: " profile_name
                    if [[ -n "$profile_name" ]]; then
                        python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
except:
    config = {}
config.setdefault('aws_profiles', {})['$CURRENT_REPO'] = '$profile_name'
with open('$HOOKS_CONFIG', 'w') as f:
    json.dump(config, f, indent=2)
"
                        echo -e "\n${GREEN}✓ Profile '$profile_name' set for repository '$CURRENT_REPO'${NC}"
                        sleep 2
                    fi
                    hide_cursor
                else
                    clear
                    echo -e "${RED}Not in a git repository${NC}"
                    sleep 2
                fi
                ;;
            2) # Any repo
                show_cursor
                clear
                echo -e "${BLUE}Add AWS profile mapping${NC}\n"
                read -p "Enter repository name: " repo_name
                if [[ -n "$repo_name" ]]; then
                    read -p "Enter AWS profile name for '$repo_name': " profile_name
                    if [[ -n "$profile_name" ]]; then
                        python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
except:
    config = {}
config.setdefault('aws_profiles', {})['$repo_name'] = '$profile_name'
with open('$HOOKS_CONFIG', 'w') as f:
    json.dump(config, f, indent=2)
"
                        echo -e "\n${GREEN}✓ Profile '$profile_name' set for repository '$repo_name'${NC}"
                        sleep 2
                    fi
                fi
                hide_cursor
                ;;
            3) # Remove mapping
                show_cursor
                clear
                echo -e "${BLUE}Remove AWS profile mapping${NC}\n"
                read -p "Enter repository name to remove: " repo_name
                if [[ -n "$repo_name" ]]; then
                    python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
    profiles = config.get('aws_profiles', {})
    if '$repo_name' in profiles:
        del profiles['$repo_name']
        with open('$HOOKS_CONFIG', 'w') as f:
            json.dump(config, f, indent=2)
        print('✓ Mapping removed')
    else:
        print('✗ Repository not found')
except Exception as e:
    print(f'✗ Error: {e}')
"
                    sleep 2
                fi
                hide_cursor
                ;;
            4) # List profiles
                show_cursor
                clear
                echo -e "${PURPLE}Available AWS Profiles:${NC}"
                if command -v aws >/dev/null 2>&1; then
                    aws configure list-profiles 2>/dev/null || echo "  (Unable to list profiles)"
                else
                    echo "  (AWS CLI not installed)"
                fi
                echo ""
                read -p "Press Enter to continue..."
                hide_cursor
                ;;
        esac
    done
}

# Install hooks in Claude settings
install_hooks() {
    clear
    echo -e "${BLUE}Installing hooks in Claude settings...${NC}"
    
    backup_settings
    
    python3 -c "
import json

try:
    with open('$CLAUDE_SETTINGS', 'r') as f:
        settings = json.load(f)
except:
    settings = {}

hooks_config = {
    'Stop': [
        {
            'matcher': '.*',
            'hooks': [
                {
                    'type': 'command',
                    'command': '$HOME/.claude/hooks/notification-beep.sh'
                }
            ]
        }
    ]
}

settings['hooks'] = hooks_config

with open('$CLAUDE_SETTINGS', 'w') as f:
    json.dump(settings, f, indent=2)

print('✓ Hooks installed successfully')
"
    
    echo -e "${GREEN}✓ Hooks have been installed in Claude settings${NC}"
    echo -e "${YELLOW}Note: Restart Claude Code for hooks to take effect${NC}"
    echo ""
    read -p "Press Enter to continue..."
}

# Show current hook status
show_status() {
    clear
    echo -e "${CYAN}╔══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}${BOLD}                    Hook Status                        ${NC}${CYAN}║${NC}"
    echo -e "${CYAN}╚══════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    # Check if hooks are installed
    if python3 -c "
import json
try:
    with open('$CLAUDE_SETTINGS', 'r') as f:
        settings = json.load(f)
    hooks = settings.get('hooks', {})
    print('true' if hooks else 'false')
except:
    print('false')
" | grep -q "true"; then
        echo -e "${GREEN}✓ Hooks are installed in Claude settings${NC}"
    else
        echo -e "${RED}✗ Hooks are not installed in Claude settings${NC}"
    fi
    
    # Check notification status
    NOTIF_STATUS=$(python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
    enabled = config.get('notifications', {}).get('enabled', True)
    sound_type = config.get('notifications', {}).get('type', 'beep')
    print(f'Enabled ({sound_type})' if enabled else 'Disabled')
except:
    print('Enabled (beep)')
")
    echo -e "Notifications: ${GREEN}$NOTIF_STATUS${NC}"
    
    # Check AWS profile mappings
    AWS_COUNT=$(python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
    profiles = config.get('aws_profiles', {})
    print(len(profiles))
except:
    print(0)
")
    echo -e "AWS Profile Mappings: ${GREEN}$AWS_COUNT configured${NC}"
    
    # Current repo info
    CURRENT_REPO=$(get_current_repo)
    if [[ -n "$CURRENT_REPO" ]]; then
        CURRENT_PROFILE=$(python3 -c "
import json
try:
    with open('$HOOKS_CONFIG', 'r') as f:
        config = json.load(f)
    profiles = config.get('aws_profiles', {})
    profile = profiles.get('$CURRENT_REPO', 'Not configured')
    print(profile)
except:
    print('Not configured')
")
        echo -e "Current Repository: ${BLUE}$CURRENT_REPO${NC} → ${GREEN}$CURRENT_PROFILE${NC}"
    fi
    
    echo ""
    read -p "Press Enter to continue..."
}

# Remove all hooks
remove_hooks() {
    clear
    echo -e "${RED}⚠️  Remove All Hooks${NC}\n"
    echo "This will remove all hook configurations from Claude settings."
    echo ""
    read -p "Are you sure? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        backup_settings
        
        python3 -c "
import json
try:
    with open('$CLAUDE_SETTINGS', 'r') as f:
        settings = json.load(f)
    if 'hooks' in settings:
        del settings['hooks']
        with open('$CLAUDE_SETTINGS', 'w') as f:
            json.dump(settings, f, indent=2)
        print('✓ Hooks removed from Claude settings')
    else:
        print('No hooks were installed')
except Exception as e:
    print(f'Error: {e}')
"
        sleep 2
    fi
}

# Main program
main() {
    ensure_hooks_config
    
    while true; do
        local options=(
            "Manage Notification Settings"
            "Manage AWS Profile Mappings"
            "Install/Update Hooks in Claude Settings"
            "View Current Hook Status"
            "Exit"
        )
        
        navigate_menu "Claude Code Hooks Manager" "${options[@]}"
        local choice=$?
        
        case $choice in
            0|5) # ESC/Quit or Exit
                clear
                echo -e "${GREEN}Thanks for using Claude Code Hooks Manager!${NC}"
                exit 0
                ;;
            1)
                notification_menu
                ;;
            2)
                aws_profile_menu
                ;;
            3)
                install_hooks
                ;;
            4)
                show_status
                ;;
        esac
    done
}

# Run the main program
main